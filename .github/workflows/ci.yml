name: CI Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: './front/package-lock.json'
    
    - name: Install Dependencies
      run: |
        rm -f package-lock.json
        npm install
        npm install -D @babel/preset-env @babel/preset-react babel-jest identity-obj-proxy jest @babel/plugin-transform-modules-commonjs @testing-library/jest-dom @testing-library/react @testing-library/user-event
      working-directory: ./front
    
    - name: Run Frontend Tests
      id: test
      run: |
        # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì´ë¯¸ JSON ì¶œë ¥ í¬í•¨)
        npm run test:ci || true
        
        # test-results.jsonê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ë³µì‚¬
        if [ -f "test-results.json" ]; then
          cp test-results.json test-results-output.json
        else
          echo '{"testResults": [], "numTotalTests": 0, "numPassedTests": 0, "numFailedTests": 0}' > test-results-output.json
        fi
        
        # ì»¤ë²„ë¦¬ì§€ëŠ” ì´ë¯¸ test:ciì— í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë³„ë„ë¡œ ì‹¤í–‰í•  í•„ìš” ì—†ìŒ
      working-directory: ./front
      env:
        CI: true
        NODE_ENV: test
      continue-on-error: true

    - name: Add Test Results Comment
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ì½ê¸° ì‹œë„
            let testResults;
            try {
              testResults = JSON.parse(fs.readFileSync('./front/test-results-output.json', 'utf8'));
            } catch (e) {
              console.log('í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨:', e);
              testResults = { testResults: [], numTotalTests: 0, numPassedTests: 0, numFailedTests: 0 };
            }

            // coverage/lcov-report/index.htmlì—ì„œ ì»¤ë²„ë¦¬ì§€ ì •ë³´ ì½ê¸° ì‹œë„
            let coverageReport = '';
            try {
              coverageReport = fs.readFileSync('./front/coverage/lcov-report/index.html', 'utf8');
              // HTMLì—ì„œ í…Œì´ë¸” ë°ì´í„° ì¶”ì¶œ (ê°„ë‹¨í•œ ì˜ˆì‹œ)
              const matches = coverageReport.match(/<span class="strong">(\d+(\.\d+)?%)<\/span>/g) || [];
              coverageReport = matches.map(m => m.replace(/<[^>]+>/g, '')).join('\n');
            } catch (e) {
              console.log('ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì½ê¸° ì‹¤íŒ¨:', e);
              coverageReport = 'ì»¤ë²„ë¦¬ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
            
            const testSummary = testResults.numFailedTests !== undefined
              ? `**ì „ì²´ ìƒíƒœ:** ${testResults.numFailedTests > 0 ? 'âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨' : 'âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼'}
              - ì´ í…ŒìŠ¤íŠ¸ ìˆ˜: ${testResults.numTotalTests}
              - í†µê³¼: ${testResults.numPassedTests}
              - ì‹¤íŒ¨: ${testResults.numFailedTests}`
              : 'í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            
            const testsByFile = ((testResults.testResults || []).length > 0) 
              ? (testResults.testResults || []).reduce((acc, suite) => {
                  if (!suite || !suite.testResults) return acc;
                  const fileName = suite.name.split('/').pop().replace('.test.js', '');
                  const tests = Array.isArray(suite.testResults) 
                    ? suite.testResults.map(test => ({
                        name: test.title,
                        status: test.status === 'passed' ? 'âœ…' : 'âŒ',
                        failureMessages: test.status === 'failed' ? test.failureMessages : []
                      }))
                    : [];
                  if (tests.length > 0) {
                    acc[fileName] = tests;
                  }
                  return acc;
                }, {})
              : {};
            
            const testStatusSection = Object.entries(testsByFile)
              .map(([fileName, tests]) => {
                if (!tests || !Array.isArray(tests)) return '';
                return `
                #### ${fileName} ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸
                ${tests.map(test => `- ${test.name} ${test.status}${test.failureMessages.length > 0 ? '\n  ```\n' + test.failureMessages.join('\n') + '\n  ```' : ''}`).join('\n')}
                `;
              })
              .filter(section => section !== '')
              .join('\n');
            
            const message = `## í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
            ${testSummary}
            
            ### ìƒì„¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼
            ${testStatusSection || 'í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}
            
            ### Coverage Report ğŸ“Š
            \`\`\`
            ${coverageReport}
            \`\`\`
            
            ğŸ•’ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„: ${new Date().toLocaleString()}`;
            
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: message
              });
            }
          } catch (error) {
            console.error('Error in test result processing:', error);
            core.setFailed(`Action failed with error: ${error.message}`);
          }