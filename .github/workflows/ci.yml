name: CI Test

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: './front/package-lock.json'
    
    - name: Install Dependencies
      run: |
        rm -f package-lock.json
        npm install
        npm install -D @babel/preset-env @babel/preset-react babel-jest identity-obj-proxy jest @babel/plugin-transform-modules-commonjs @testing-library/jest-dom @testing-library/react @testing-library/user-event
      working-directory: ./front
    
    - name: Run Frontend Tests
      id: test
      run: |
        # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ê²°ê³¼ ì €ì¥
        npm run test:ci -- --json --outputFile=test-results.json || true
        
        if [ -f "test-results.json" ]; then
          echo "TEST_RESULTS<<EOF" >> $GITHUB_ENV
          cat test-results.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì—¬ë¶€ í™•ì¸
          if [ "$(jq '.numFailedTests' test-results.json)" != "0" ]; then
            echo "TEST_FAILED=true" >> $GITHUB_ENV
          else
            echo "TEST_FAILED=false" >> $GITHUB_ENV
          fi
        else
          echo "TEST_FAILED=true" >> $GITHUB_ENV
        fi
        
        # ì»¤ë²„ë¦¬ì§€ ê²°ê³¼ ìˆ˜ì§‘
        echo "COVERAGE_REPORT<<EOF" >> $GITHUB_ENV
        npm test -- --coverage --coverageReporters="text-summary" 2>&1 | tail -n 4 >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
      working-directory: ./front
      env:
        CI: true
        NODE_ENV: test
      continue-on-error: true

    - name: Add Test Results Comment
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          try {
            const testResults = JSON.parse(process.env.TEST_RESULTS || '{}');
            const coverageReport = process.env.COVERAGE_REPORT || '';
            
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹±
            const testResults = testResults.testResults || [];
            const failedTests = testResults.numFailedTests || 0;
            const passedTests = testResults.numPassedTests || 0;
            const totalTests = testResults.numTotalTests || 0;
            
            // íŒŒì¼ë³„ë¡œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê·¸ë£¹í™”
            const testsByFile = testResults.reduce((acc, suite) => {
              const fileName = suite.name.split('/').pop().replace('.test.js', '');
              const tests = suite.testResults.map(test => ({
                name: test.title,
                status: test.status === 'passed' ? 'âœ…' : 'âŒ',
                failureMessages: test.status === 'failed' ? test.failureMessages : []
              }));
              acc[fileName] = tests;
              return acc;
            }, {});

            // íŒŒì¼ë³„ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¬¸ìì—´ ìƒì„±
            const testStatusSection = Object.entries(testsByFile)
              .map(([fileName, tests]) => `
              #### ${fileName} ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸
              ${tests.map(test => `- ${test.name} ${test.status}${
                test.failureMessages.length > 0 
                  ? '\n  ```\n  ' + test.failureMessages.join('\n  ') + '\n  ```'
                  : ''
              }`).join('\n')}
              `).join('\n');

            const message = `## í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½

            ### Frontend Tests ğŸŒ
            **ì „ì²´ ìƒíƒœ:** ${process.env.TEST_FAILED === 'true' ? 'âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨' : 'âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼'}
            
            **í…ŒìŠ¤íŠ¸ í†µê³„:**
            - ì´ í…ŒìŠ¤íŠ¸ ìˆ˜: ${totalTests}
            - í†µê³¼: ${passedTests}
            - ì‹¤íŒ¨: ${failedTests}

            ### ìƒì„¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼
            ${testStatusSection}

            ### Coverage Report ğŸ“Š
            \`\`\`
            ${coverageReport}
            \`\`\`

            ---
            ğŸ•’ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„: ${new Date().toLocaleString()}`;

            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: message
              });
            }
          } catch (error) {
            core.setFailed(`Action failed with error: ${error}`);
          }