name: CI Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: './front/package-lock.json'
    
    - name: Install Dependencies
      run: |
        rm -f package-lock.json
        npm install
        npm install -D jest @babel/preset-env @babel/preset-react babel-jest identity-obj-proxy @babel/plugin-transform-modules-commonjs @testing-library/jest-dom @testing-library/react @testing-library/user-event
      working-directory: ./front
    
    - name: Run Frontend Tests
      id: test
      run: |
        # Jest ì§ì ‘ ì‹¤í–‰
        ./node_modules/.bin/jest --json --outputFile=test-results.json --testMatch='**/src/test/**/*.test.js' --coverage --ci || true
        
        # ê²°ê³¼ íŒŒì¼ ìƒì„± í™•ì¸ ë° ë””ë²„ê¹…
        echo "Checking test results file..."
        ls -la test-results.json || echo "test-results.json not found"
        
        # ê²°ê³¼ íŒŒì¼ ë‚´ìš© ì¶œë ¥
        if [ -f "test-results.json" ]; then
          echo "Test results content:"
          cat test-results.json
        fi
      working-directory: ./front
      env:
        CI: true
        NODE_ENV: test
      continue-on-error: true

    - name: Add Test Results Comment
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            console.log('Starting test results processing...');
            
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ì½ê¸°
            const testResultsPath = './front/test-results.json';
            console.log('Reading test results from:', testResultsPath);
            
            let testResults;
            try {
              const resultContent = fs.readFileSync(testResultsPath, 'utf8');
              console.log('Raw test results content:', resultContent);
              testResults = JSON.parse(resultContent);
            } catch (e) {
              console.error('Error reading test results:', e);
              testResults = null;
            }
            
            // ì»¤ë²„ë¦¬ì§€ ê²°ê³¼ ì½ê¸°
            const coverageSummaryPath = './front/coverage/coverage-summary.json';
            let coverageData;
            try {
              coverageData = JSON.parse(fs.readFileSync(coverageSummaryPath, 'utf8'));
            } catch (e) {
              console.error('Error reading coverage data:', e);
              coverageData = null;
            }
            
            // í…ŒìŠ¤íŠ¸ ìš”ì•½ ìƒì„±
            const testSummary = testResults ? 
              `**ì „ì²´ ìƒíƒœ:** ${testResults.numFailedTests > 0 ? 'âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨' : 'âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼'}
              - ì´ í…ŒìŠ¤íŠ¸ ìˆ˜: ${testResults.numTotalTests}
              - í†µê³¼: ${testResults.numPassedTests}
              - ì‹¤íŒ¨: ${testResults.numFailedTests}`
              : 'í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            
            // ìƒì„¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìƒì„±
            let detailedResults = '';
            if (testResults && testResults.testResults) {
              console.log('Processing test suites...');
              detailedResults = testResults.testResults
                .filter(suite => suite && suite.testResults)
                .map(suite => {
                  const fileName = suite.name.split('/').pop().replace('.test.js', '');
                  const suiteResults = suite.testResults
                    .map(test => {
                      const status = test.status === 'passed' ? 'âœ…' : 'âŒ';
                      const failures = test.failureMessages && test.failureMessages.length > 0
                        ? `\n  \`\`\`\n  ${test.failureMessages.join('\n  ')}\n  \`\`\``
                        : '';
                      return `- ${status} ${test.title}${failures}`;
                    })
                    .join('\n');
                  
                  return `#### ${fileName}\n${suiteResults}`;
                })
                .join('\n\n');
            }
            
            // ì»¤ë²„ë¦¬ì§€ ì •ë³´ ìƒì„±
            let coverageReport = '';
            if (coverageData) {
              const total = coverageData.total;
              coverageReport = `
              Statement Coverage: ${total.statements.pct}%
              Branch Coverage: ${total.branches.pct}%
              Function Coverage: ${total.functions.pct}%
              Line Coverage: ${total.lines.pct}%
              `;
            } else {
              coverageReport = 'ì»¤ë²„ë¦¬ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
            
            const message = `## í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
            ${testSummary}
            
            ### ìƒì„¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼
            ${detailedResults || 'ìƒì„¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}
            
            ### Coverage Report ğŸ“Š
            \`\`\`
            ${coverageReport}
            \`\`\`
            
            ğŸ•’ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„: ${new Date().toLocaleString()}`;
            
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: message
              });
            }
          } catch (error) {
            console.error('Error in test result processing:', error);
            core.setFailed(`Action failed with error: ${error.message}`);
          }