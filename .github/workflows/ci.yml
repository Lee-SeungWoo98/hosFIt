name: CI Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: './front/package-lock.json'
    
    - name: Install Dependencies
      run: |
        rm -f package-lock.json
        npm install
        npm install -D @babel/preset-env @babel/preset-react babel-jest identity-obj-proxy jest @babel/plugin-transform-modules-commonjs @testing-library/jest-dom @testing-library/react @testing-library/user-event
      working-directory: ./front
    
    - name: Run Frontend Tests
      id: test
      run: |
        npm run test:ci || true

        # 테스트 결과 JSON 파일 저장
        if [ -f "test-results.json" ]; then
          mv test-results.json test-results-output.json
        else
          echo "{}" > test-results-output.json
        fi

        # 커버리지 결과 저장
        npm run test:ci -- --coverage --coverageReporters="text-summary" > coverage-summary.txt
      working-directory: ./front
      env:
        CI: true
        NODE_ENV: test
      continue-on-error: true

    - name: Add Test Results Comment
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            // 테스트 결과 파일 읽기
            const testResults = JSON.parse(fs.readFileSync('./front/test-results-output.json', 'utf8'));
            const coverageReport = fs.readFileSync('./front/coverage-summary.txt', 'utf8');
            
            const testSummary = testResults.numFailedTests !== undefined
              ? `**전체 상태:** ${testResults.numFailedTests > 0 ? '❌ 일부 테스트 실패' : '✅ 모든 테스트 통과'}
              - 총 테스트 수: ${testResults.numTotalTests}
              - 통과: ${testResults.numPassedTests}
              - 실패: ${testResults.numFailedTests}`
              : '테스트 결과를 불러오는 데 실패했습니다.';

            const testsByFile = (testResults.testResults || []).reduce((acc, suite) => {
              const fileName = suite.name.split('/').pop().replace('.test.js', '');
              const tests = suite.testResults.map(test => ({
                name: test.title,
                status: test.status === 'passed' ? '✅' : '❌',
                failureMessages: test.status === 'failed' ? test.failureMessages : []
              }));
              acc[fileName] = tests;
              return acc;
            }, {});

            const testStatusSection = Object.entries(testsByFile)
              .map(([fileName, tests]) => `
              #### ${fileName} 컴포넌트 테스트
              ${tests.map(test => `- ${test.name} ${test.status}${test.failureMessages.length > 0 ? '\n  ```\n' + test.failureMessages.join('\n') + '\n  ```' : ''}`).join('\n')}
              `).join('\n');

            const message = `## 테스트 결과 요약
            ${testSummary}

            ### 상세 테스트 결과
            ${testStatusSection}

            ### Coverage Report 📊
            \`\`\`
            ${coverageReport}
            \`\`\`

            🕒 테스트 실행 시간: ${new Date().toLocaleString()}`;

            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: message
              });
            }
          } catch (error) {
            core.setFailed(`Action failed with error: ${error.message}`);
          }
