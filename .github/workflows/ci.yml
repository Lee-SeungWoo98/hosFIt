name: CI Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: './front/package-lock.json'
    
    - name: Install Dependencies
      run: |
        rm -f package-lock.json
        npm install
        npm install -D @babel/preset-env @babel/preset-react babel-jest identity-obj-proxy jest @babel/plugin-transform-modules-commonjs @testing-library/jest-dom @testing-library/react @testing-library/user-event
      working-directory: ./front
    
    - name: Run Frontend Tests
      id: test
      run: |
        npm run test:ci
      working-directory: ./front
      env:
        CI: true
        NODE_ENV: test
      continue-on-error: true

    - name: Add Test Results Comment
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ì½ê¸°
            const resultContent = fs.readFileSync('./front/test-results.json', 'utf8');
            const testResults = JSON.parse(resultContent);
            
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ ìƒì„±
            const testSummary = `**ì „ì²´ ìƒíƒœ:** ${testResults.numFailedTests > 0 ? 'âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨' : 'âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼'}
            - ì´ í…ŒìŠ¤íŠ¸ ìˆ˜: ${testResults.numTotalTests}
            - í†µê³¼: ${testResults.numPassedTests}
            - ì‹¤íŒ¨: ${testResults.numFailedTests}`;
            
            // í…ŒìŠ¤íŠ¸ ìƒì„¸ ê²°ê³¼ ìƒì„±
            let detailedResults = '';
            
            testResults.testResults.forEach(suite => {
              const fileName = suite.name.split('/').pop();
              detailedResults += `\n### ${fileName}\n\n`;
              
              suite.assertionResults.forEach(test => {
                const status = test.status === 'passed' ? 'âœ…' : 'âŒ';
                const fullTitle = test.fullName || test.title;
                detailedResults += `${status} ${fullTitle}\n`;
                
                if (test.failureMessages && test.failureMessages.length > 0) {
                  detailedResults += '```\n' + test.failureMessages.join('\n') + '\n```\n';
                }
              });
            });
            
            // ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ì •ë³´ ì¶”ì¶œ
            let coverageInfo = '';
            if (testResults.coverageMap) {
              const totalCoverage = Object.values(testResults.coverageMap).reduce((acc, file) => {
                const statements = file.s || {};
                const covered = Object.values(statements).filter(v => v > 0).length;
                const total = Object.values(statements).length;
                return {
                  covered: acc.covered + covered,
                  total: acc.total + total
                };
              }, { covered: 0, total: 0 });
              
              const coveragePercent = (totalCoverage.covered / totalCoverage.total * 100).toFixed(2);
              coverageInfo = `\n### ì½”ë“œ ì»¤ë²„ë¦¬ì§€\nì „ì²´ ì»¤ë²„ë¦¬ì§€: ${coveragePercent}%\n`;
            }
            
            // ìµœì¢… ë©”ì‹œì§€ êµ¬ì„±
            const message = `## í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
            ${testSummary}
            
            ## ìƒì„¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼
            ${detailedResults || 'ìƒì„¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}
            
            ${coverageInfo}
            
            ğŸ•’ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„: ${new Date().toLocaleString()}`;
            
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: message
              });
            }
          } catch (error) {
            console.error('Error in test result processing:', error);
            core.setFailed(`Action failed with error: ${error.message}`);
          }